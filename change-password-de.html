<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Passwort ändern – MN Teaching</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="design.css" />

  <style>
    * {
      box-sizing: border-box;
    }
  </style>
</head>

<body>

<!-- Load logged-in user -->
<script>
  let user = JSON.parse(localStorage.getItem("user"));
  if (!user) window.location.href = "client-portal-de.html";
</script>

<!-- HEADER -->
<header class="site-header">
  <div class="header-inner">

    <div class="logo-container">
      <img src="logo-MNBTeaching.png" alt="MN Teaching Logo">
    </div>

    <nav class="nav-center">
        <a href="dashboard-de.html">Dashboard</a>
        <a id="nav-payments" href="payments-de.html">Zahlungen</a>

        <a href="change-password.html" class="lang-flag">
            <img src="uk.png" alt="English">
        </a>
   </nav>

    <div class="header-right">
        <button class="change-password-btn" id="change-password-btn-desktop" style="margin-right: 10px;">
          Passwort ändern
        </button>
        <button class="logout-btn" id="logout-btn">Abmelden</button>
    </div>

    <div class="hamburger" id="hamburger">
        <div class="line"><span></span></div>
        <div class="line"><span></span></div>
        <div class="line"><span></span></div>
    </div>

    <div class="mobile-menu" id="mobileMenu">
      <a href="dashboard-de.html">Dashboard</a>
      <a id="mnav-payments" href="payments-de.html">Zahlungen</a>

      <a href="change-password.html" class="lang-flag">
        <img src="uk.png" alt="English">
      </a>

      <button class="change-password-btn" id="change-password-btn-mobile">
        Passwort ändern
      </button>

      <button class="logout-btn" id="logout-btn-mobile">Abmelden</button>
    </div>

  </div>
</header>

<!-- CHANGE PASSWORD FORM -->
<section style="padding: 80px 20px; background-color: #fff7de;">
  <div style="
    max-width: 420px;
    margin: 0 auto;
    background: white;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    text-align: center;
  ">
    <h2 style="color: #1c3b5a; margin-bottom: 24px;">Passwort ändern</h2>

    <form id="change-password-form">

      <!-- OLD PASSWORD -->
      <div style="position: relative; margin-bottom: 14px; width: 100%; box-sizing: border-box;">
        <input id="old-password" type="password" placeholder="Aktuelles Passwort" required
          style="
            width: 100%;
            padding: 12px 42px 12px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
            box-sizing: border-box;
          ">

        <button type="button" id="toggle-old"
          style="
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: #000;
            padding: 0;
            width: 24px;
            height: 24px;
          ">
          &#128065;
        </button>
      </div>

      <!-- NEW PASSWORD -->
      <div style="position: relative; margin-bottom: 14px; width: 100%; box-sizing: border-box;">
        <input id="new-password" type="password" placeholder="Neues Passwort" required
          style="
            width: 100%;
            padding: 12px 42px 12px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
            box-sizing: border-box;
          ">

        <button type="button" id="toggle-new"
          style="
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: #000;
            padding: 0;
            width: 24px;
            height: 24px;
          ">
          &#128065;
        </button>
      </div>

      <!-- CONFIRM NEW PASSWORD -->
      <div style="position: relative; margin-bottom: 20px; width: 100%; box-sizing: border-box;">
        <input id="confirm-password" type="password" placeholder="Neues Passwort bestätigen" required
          style="
            width: 100%;
            padding: 12px 42px 12px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
            box-sizing: border-box;
          ">

        <button type="button" id="toggle-confirm"
          style="
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: #000;
            padding: 0;
            width: 24px;
            height: 24px;
          ">
          &#128065;
        </button>
      </div>

      <!-- SUBMIT BUTTON -->
      <button type="submit"
        style="
          width: 100%;
          padding: 14px;
          background-color: #3ecacb;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 1.1rem;
          cursor: pointer;
        ">
        Passwort aktualisieren
      </button>

    </form>

    <pre id="password-message" style="margin-top: 20px; color: #1c3b5a;"></pre>

  </div>
</section>

<!-- PAGE SCRIPT -->
<script>
  const form = document.getElementById("change-password-form");
  const message = document.getElementById("password-message");

  function addToggle(id, toggleId) {
    const input = document.getElementById(id);
    const btn = document.getElementById(toggleId);

    btn.addEventListener("click", () => {
      input.type = input.type === "password" ? "text" : "password";
    });
  }

  addToggle("old-password", "toggle-old");
  addToggle("new-password", "toggle-new");
  addToggle("confirm-password", "toggle-confirm");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const oldPassword = document.getElementById("old-password").value;
    const newPassword = document.getElementById("new-password").value;
    const confirmPassword = document.getElementById("confirm-password").value;

    if (!oldPassword.trim()) {
      message.textContent = "Bitte gib dein aktuelles Passwort ein.";
      message.style.color = "red";
      return;
    }

    if (newPassword !== confirmPassword) {
      message.textContent = "Die neuen Passwörter stimmen nicht überein.";
      message.style.color = "red";
      return;
    }

    message.textContent = "Passwort wird aktualisiert...";

    try {
      const res = await fetch("http://localhost:4000/api/update-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: user.email,
          oldPassword,
          newPassword
        })
      });

      const data = await res.json();

      if (data.error) {
        message.textContent = data.error;
        message.style.color = "red";
        return;
      }

      message.textContent = "Passwort erfolgreich aktualisiert!";
      message.style.color = "green";

    } catch (err) {
      message.textContent = "Netzwerkfehler: " + err.message;
      message.style.color = "red";
    }
  });

  function logout() {
    localStorage.removeItem("user");
    window.location.href = "client-portal-de.html";
  }

  const logoutBtn = document.getElementById("logout-btn");
  const logoutBtnMobile = document.getElementById("logout-btn-mobile");

  if (logoutBtn) logoutBtn.onclick = logout;
  if (logoutBtnMobile) logoutBtnMobile.onclick = logout;

  if (user.role === "student" || user.role === "teacher") {
    const navPayments = document.getElementById("nav-payments");
    const mnavPayments = document.getElementById("mnav-payments");
    if (navPayments) navPayments.style.display = "none";
    if (mnavPayments) mnavPayments.style.display = "none";
  }
</script>

<script src="main.js"></script>

</body>
</html>